package com.chatapp.controller;  
  
import com.chatapp.model.ChatMessage;  
import com.chatapp.service.ChatService;  
import com.fasterxml.jackson.databind.ObjectMapper;  
import org.springframework.web.socket.TextMessage;  
import org.springframework.web.socket.WebSocketSession;  
import org.springframework.web.socket.handler.TextWebSocketHandler;  
  
public class ChatWebSocketHandler extends TextWebSocketHandler {  
  
    private final ChatService chatService;  
    private final ObjectMapper objectMapper = new ObjectMapper();  
  
    public ChatWebSocketHandler(ChatService chatService) {  
        this.chatService = chatService;  
    }  
  
    @Override  
    public void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {  
        ChatMessage chatMessage = objectMapper.readValue(message.getPayload(), ChatMessage.class);  
        chatService.saveMessage(chatMessage).subscribe();  
        session.sendMessage(new TextMessage("Received: " + chatMessage.getContent()));  
    }  
}  
